<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title> üöõ Despacho</title>
    <style>
      html,body{height:100%;}
      *{box-sizing:border-box;margin:0;padding:0}
      body{ font-family: Arial, Helvetica, sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:0;display:flex;flex-direction:column}
      .container{width:100%;max-width:none;margin:0 auto;padding:20px;display:flex;flex-direction:column;min-height:100vh}
      header{background:linear-gradient(90deg,#05e479,#6610f2);color:#fff;padding:28px;border-radius:10px;margin-bottom:18px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.18)}
      .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:16px}
      .card{background:#fff;padding:16px;border-radius:10px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.08)}
      .card-label{font-size:11px;color:#666;text-transform:uppercase;margin-bottom:6px}
      .card-value{font-size:22px;font-weight:700;color:#000000}
      .controls{background:#fff;padding:14px;border-radius:10px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
      .controls .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:10px}
      input,select{padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
      .buttons{display:flex;gap:8px;flex-wrap:wrap}
      .btn{padding:10px 14px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
      .btn.primary{background:#0a66ff;color:#fff}
      .btn.success{background:#28a745;color:#fff}
      .btn.warn{background:#ffc107;color:#111}
      .error{display:none;background:#fdecea;color:#611;padding:10px;border-radius:6px;margin-bottom:10px}
      
      .table-wrap{
        background:#fff;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.06);
        margin-bottom:24px;flex:1;
        font-family: inherit;
        display:flex;
        flex-direction:column;
        overflow:auto;
      }

      .highlight{transition:background 0.6s ease; background:rgba(255,255,0,0.18)}
      .new-row{opacity:0.98}
      .table-header table{width:100%;border-collapse:collapse}
      .table-body{flex:1;overflow:auto}
      .table-body table{width:100%;border-collapse:collapse}
      thead th{background:linear-gradient(90deg,#0a66ff,#6610f2);color:#fff;padding:12px;text-align:left;font-size:13px;position:sticky;top:0}
      tbody td{padding:10px;border-bottom:1px solid #eee;font-size:13px}
      .status-cargando{background:#ffc107;color:#000;padding:4px 10px;border-radius:999px;font-weight:700}
      .status-despachado{background:#28a745;color:#fff;padding:4px 10px;border-radius:999px;font-weight:700}
      .empty{padding:26px;text-align:center;color:#777}
      @media(max-width:768px){.controls .row{grid-template-columns:1fr}.buttons{flex-direction:column}.btn{width:100%}}
      table{ border-collapse:collapse; } thead th{ border:3px solid rgb(0, 0, 0); } tbody td{ border:3px solid #0b0a0a; }
      @media (max-width: 600px){
        body, .container{ height: auto !important; min-height: auto !important; }
        .table-wrap{ flex: none !important; max-height: none !important; overflow-x: auto; overflow-y: visible; margin-bottom: 40px; }
        table{ min-width: 900px; }
      }
      thead th:first-child, tbody td:first-child{ text-align: center; font-weight: bold; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
       <h1 style="font-size:60px;">üì¶ SOLICITUD DE DESPACHO</h1>
      </header>

      <div class="dashboard">
        <div class="card"><div class="card-label">üìù Total Registros</div><div id="registros" class="card-value">0</div></div>
        <div class="card"><div class="card-label">üìà Filtrados</div><div id="filtrados" class="card-value">0</div></div>
        <div class="card"><div class="card-label">‚úÖ Estado</div><div id="estado" class="card-value">‚óè</div></div>
        <div class="card"><div class="card-label">üåê √öltima actualizaci√≥n</div><div id="ultima" class="card-value">‚Äî</div></div>
      </div>

      <div class="controls">
        <div id="errorMsg" class="error"></div>
        <div class="row">
          <input id="filterTransportadora" placeholder="Transportadora">
          <input id="filterPlaca" placeholder="Placa">
          <input id="filterConductor" placeholder="Conductor">
          <input id="filterproducto" placeholder="Producto">
          <input id="filterFecha" type="date">
        </div>
        <div class="buttons">
          <button id="btnFiltrar" class="btn primary">üîç Aplicar filtros</button>
          <button id="btnLimpiar" class="btn warn">üîÑ Limpiar</button>
          <button id="btnDescargarExcel" class="btn success">üìä Descargar Excel</button>
          <button id="btnActualizar" class="btn primary">üîÅ Sincronizar ahora</button>
          <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px;color:#222">
            <input type="checkbox" id="forceProxy"> 
          </label>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>üöõ Transportadora </th>
              <th>üßëüèº‚Äç‚úàÔ∏è Conductor</th>
              <th>ü™™ C√©dula</th>
              <th>‚õî Placa</th>
              <th>üìç Destino</th>
              <th>üì¶ Producto</th>
              <th>üìÖ Fecha Planificada de Cargue</th>
              <th>üì∏ Evidencia Estado Carrocer√≠a</th>
              <th>üóëÔ∏è Eliminar</th></tr>
          </thead>
          <tbody id="tablaBody"><tr><td colspan="10" class="empty">Cargando datos...</td></tr></tbody>
        </table>
      </div>
    </div>
     
    <script>
      const ADMIN_PASS = 'admin123';

      const URL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTuMV8Hfu6NBC0w2vuWseAmTcU957vz_ZfYwluoop1BaDvs80SiuJFJYA2H8UFv0zAw8hbB5CqygIIO/pub?gid=651791819&single=true&output=csv';
      // URL DEL FORMULARIO DE RESPUESTA
      const URL_FORM_RESPUESTAS = 'https://docs.google.com/spreadsheets/d/1raQZtQ8sLRzao8SxGf1x2pt-bSF-Ubozau30_zLlpEc/export?format=csv&gid=651791819';
      
      let datosOriginales = [];
      let datosFormulario = [];
      let registrosNotificados = new Set();

      const tablaBody = document.getElementById('tablaBody');
      const registrosEl = document.getElementById('registros');
      const filtradosEl = document.getElementById('filtrados');
      const ultimaEl = document.getElementById('ultima');
      const estadoEl = document.getElementById('estado');
      const errorMsg = document.getElementById('errorMsg');

      const fTransport = document.getElementById('filterTransportadora');
      const fPlaca = document.getElementById('filterPlaca');
      const fConductor = document.getElementById('filterConductor');
      const fproducto = document.getElementById('filterproducto');
      const fFecha = document.getElementById('filterFecha');

      const btnFiltrar = document.getElementById('btnFiltrar');
      const btnLimpiar = document.getElementById('btnLimpiar');
      const btnXLS = document.getElementById('btnDescargarExcel');
      const btnActualizar = document.getElementById('btnActualizar');

      // NUEVA FUNCI√ìN: Cargar datos del formulario de respuestas
      async function cargarFormularioRespuestas(){
        try{
          const res = await fetch(URL_FORM_RESPUESTAS + '&t=' + Date.now(), { cache: 'no-store' });
          if(!res.ok) {
            console.warn('Formulario de respuestas no disponible (HTTP ' + res.status + ')');
            return [];
          }
          const text = await res.text();
          const datos = parseCSV(text);
          console.log('Formulario cargado: ' + datos.length + ' registros');
          return datos;
        }catch(e){
          console.warn('No se pudo cargar formulario de respuestas:', e.message);
          return [];
        }
      }

      // NUEVA FUNCI√ìN: Completar registro con datos del formulario
      function completarRegistroDesdeFormulario(registro, datosForm){
        const registroCompleto = {...registro};
        
        if(!datosForm || datosForm.length === 0) return registroCompleto;
        
        // Buscar por c√©dula (m√°s confiable)
        let coincidencia = null;
        
        // 1. B√∫squeda por C√âDULA
        const cedula = (registro.cedula || registro['C√©dula'] || registro['c√©dula'] || '').trim();
        if(cedula && cedula.length >= 5){
          coincidencia = datosForm.find(f => {
            const formCed = (f.cedula || f['C√©dula'] || f['c√©dula'] || '').trim();
            return formCed === cedula;
          });
        }
        
        // 2. Si no encuentra por c√©dula, buscar por PLACA
        if(!coincidencia){
          const placa = (registro.placa || registro['Placa'] || '').trim().toUpperCase();
          if(placa && placa.length >= 4){
            coincidencia = datosForm.find(f => {
              const formPlaca = (f.placa || f['Placa'] || '').trim().toUpperCase();
              return formPlaca === placa;
            });
          }
        }
        
        // 3. Si no encuentra por placa, buscar por CONDUCTOR
        if(!coincidencia){
          const conductor = (registro.conductor || registro['Conductor'] || '').trim().toUpperCase();
          if(conductor && conductor.length >= 5){
            coincidencia = datosForm.find(f => {
              const formConductor = (f.conductor || f['Conductor'] || '').trim().toUpperCase();
              return formConductor === conductor || formConductor.includes(conductor);
            });
          }
        }
        
        // Si encontr√≥ coincidencia, llenar campos vac√≠os
        if(coincidencia){
          const camposMapeo = {
            'transportadora': ['transportadora', 'Transportadora'],
            'conductor': ['conductor', 'Conductor'],
            'cedula': ['cedula', 'C√©dula', 'c√©dula'],
            'placa': ['placa', 'Placa'],
            'destino': ['destino', 'Destino'],
            'producto': ['producto a cargar', 'Producto a cargar', 'producto', 'Producto'],
            'fecha': ['fecha planificada de cargue', 'Fecha planificada de cargue', 'fecha', 'Fecha'],
            'evidencia': ['evidencia estado carrocer√≠a', 'Evidencia estado carrocer√≠a', 'evidencia', 'Evidencia']
          };
          
          // Llenar cada campo
          for(let campoLocal in camposMapeo){
            const valoresActuales = (registroCompleto[campoLocal] || registroCompleto[Object.values(camposMapeo[campoLocal])[0]] || '').trim();
            
            // Solo llenar si el campo est√° vac√≠o o muy corto
            if(!valoresActuales || valoresActuales.length < 2){
              // Buscar en el formulario con cualquiera de las variantes de nombre
              for(let variante of camposMapeo[campoLocal]){
                const valorFormulario = (coincidencia[variante] || '').trim();
                if(valorFormulario && valorFormulario.length > 0){
                  registroCompleto[campoLocal] = valorFormulario;
                  break;
                }
              }
            }
          }
        }
        
        return registroCompleto;
      }

      function parseCSV(text){
        const rows=[];
        const lines = text.replace(/\r/g,'').split('\n');
        if(lines.length < 2) return rows;
        
        const headerLine = lines[0];
        
        function parseCSVLine(line) {
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for(let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if(char === '"') {
              if(inQuotes && nextChar === '"') {
                current += '"';
                i++;
              } else {
                inQuotes = !inQuotes;
              }
            } else if(char === ',' && !inQuotes) {
              values.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current);
          return values;
        }
        
        const headerValues = parseCSVLine(headerLine);
        const expectedFields = headerValues.length;
        
        const headers = []; 
        headerValues.forEach(h => {
          let clean = h.trim();
          clean = clean.replace(/^"|"$/g, '').trim();
          clean = clean.toLowerCase();
          headers.push(clean);
        });
        
        let i = 1;
        while(i < lines.length) {
          const currentLine = lines[i];
          
          if(!currentLine || !currentLine.trim()) {
            i++;
            continue;
          }
          
          if(/^\s/.test(currentLine) || /^https?:\/\//.test(currentLine.trim())) {
            i++;
            continue;
          }
          
          let line = currentLine;
          let values = parseCSVLine(line);
          
          while(values.length < expectedFields && i + 1 < lines.length) {
            const nextLine = lines[i + 1];
            
            if(!nextLine || !nextLine.trim()) {
              i++;
              continue;
            }
            
            if(/^\s/.test(nextLine)) {
              i++;
              if(nextLine.trim()) {
                line += '\n' + nextLine;
                values = parseCSVLine(line);
              }
              continue;
            }
            
            if(/^https?:\/\//.test(nextLine.trim())) {
              i++;
              line += '\n' + nextLine;
              values = parseCSVLine(line);
              continue;
            }
            
            if(/^\d{6,}/.test(nextLine.trim())) {
              i++;
              line += '\n' + nextLine;
              values = parseCSVLine(line);
              continue;
            }
            
            if(/^[A-Z]{2,3}\d{3,4}/.test(nextLine.trim())) {
              i++;
              line += '\n' + nextLine;
              values = parseCSVLine(line);
              continue;
            }
            
            if(!nextLine.includes(',') || nextLine.split(',').length === 1) {
              i++;
              line += '\n' + nextLine;
              values = parseCSVLine(line);
              continue;
            }
            
            const nextCommas = (nextLine.match(/,/g) || []).length;
            if(nextCommas >= expectedFields - 2) {
              break;
            }
            
            i++;
            if(nextLine.trim()) {
              line += '\n' + nextLine;
              values = parseCSVLine(line);
            }
          }
          
          for(let j = 0; j < values.length; j++) {
            let val = values[j].trim();
            val = val.replace(/^"|"$/g, '').trim();
            values[j] = val;
          }
          
          while(values.length < expectedFields) {
            values.push('');
          }
          values = values.slice(0, expectedFields);
          
          const obj = {};
          for(let j = 0; j < headers.length; j++) {
            obj[headers[j]] = values[j] || '';
          }
          
          // CAMBIO: Aceptar TODOS los registros (incluso con 1 solo campo)
          // Solo rechazar l√≠neas completamente vac√≠as
          const tieneAlgo = Object.values(obj).some(v => {
            const trimmed = (v || '').trim();
            return trimmed.length > 0 && 
                   !trimmed.match(/^https?:|google|drive|docs|sheet/i) &&
                   trimmed !== '‚Äî';
          });
          
          if(tieneAlgo) {
            rows.push(obj);
          }
          
          i++;
        }
        
        return rows;
      }

      function obtenerFechaISO(valor){
        if(!valor) return null;
        valor = valor.trim().split(' ')[0];
        if(valor.includes('/')){
          const [d,m,y] = valor.split('/');
          return new Date(y, m-1, d);
        }
        if(valor.match(/^\d{4}-\d{2}-\d{2}$/)){
          const [y,m,d] = valor.split('-');
          return new Date(y, m-1, d);
        }
        return null;
      }

      // Reemplazar la funci√≥n renderTabla() completa por:

function renderTabla(datos){
  tablaBody.innerHTML = '';

  if(!datos.length){
    tablaBody.innerHTML = '<tr><td colspan="10" class="empty">No hay datos</td></tr>';
    filtradosEl.textContent = '0';
    return;
  }

  const datosInvertidos = Array.from(datos).reverse();

  datosInvertidos.forEach((r, displayIndex) => {
    const tr = document.createElement('tr');
    const originalIndex = datos.length - 1 - displayIndex;
    const numeroFila = datos.length - displayIndex;
    tr.setAttribute('data-index', originalIndex);
    
    function getField(fieldNames) {
      if(typeof fieldNames === 'string') fieldNames = [fieldNames];
      
      for(let fieldName of fieldNames) {
        if(r[fieldName] && r[fieldName].toString().trim().length > 0) {
          return r[fieldName].toString().trim();
        }
        const lower = fieldName.toLowerCase();
        for(let key in r) {
          if(key.toLowerCase() === lower && r[key] && r[key].toString().trim().length > 0) {
            return r[key].toString().trim();
          }
        }
        for(let key in r) {
          if(key.toLowerCase().includes(lower) && r[key] && r[key].toString().trim().length > 0) {
            return r[key].toString().trim();
          }
        }
      }
      return '';
    }
    
    let transportadora = getField(['transportadora', 'Transportadora']);
    let conductor = getField(['conductor', 'Conductor']);
    let cedula = getField(['cedula', 'c√©dula', 'Cedula', 'C√©dula']);
    let placa = getField(['placa', 'Placa']);
    let destino = getField(['destino', 'Destino']);
    let producto = getField(['producto a cargar', 'Producto a cargar', 'producto', 'Producto']);
    let fecha = getField(['fecha planificada de cargue', 'Fecha planificada de cargue', 'fecha', 'Fecha']);
    let evidencia = getField(['evidencia estado carrocer√≠a', 'Evidencia estado carrocer√≠a', 'evidencia', 'Evidencia']);
    
    const allText = Object.values(r).join('\n');
    const allTextUpper = allText.toUpperCase();
    
    // PASO 1: COMPLETAR DESDE FORMULARIO DE RESPUESTAS (PRIORIDAD M√ÅXIMA)
    // ‚ùå ELIMINADO - YA SE HACE EN cargarDatos()
    
    // PASO 2: B√öSQUEDAS HEUR√çSTICAS (Solo si siguen vac√≠os)
    
    // C√âDULA
    if(!cedula || cedula.length < 5){
      const cedulaRegex = /\b(\d{6,15}(?:[.-]?\d+)*)\b/;
      const match = allText.match(cedulaRegex);
      if(match && match[1] && match[1].length >= 6) {
        cedula = match[1].replace(/[.-\s]/g, '').substring(0, 15);
      }
    }
    cedula = cedula.replace(/^https?.*$/i, '').trim();
    
    // PLACA
    if(!placa || placa.length < 4){
      const placaRegex = /\b([A-Z]{2,3}[\s\-]?\d{3,4})\b/;
      const match = allText.match(placaRegex);
      if(match && match[1]) {
        placa = match[1].replace(/[\s\-]/g, '').toUpperCase();
      } else {
        const fallbackRegex = /([A-Z]{2,4}\d{2,4})/;
        const fallbackMatch = allText.match(fallbackRegex);
        if(fallbackMatch && fallbackMatch[1]) {
          placa = fallbackMatch[1].toUpperCase();
        }
      }
    }
    placa = placa.replace(/^https?.*$/i, '').trim().toUpperCase();
    
    // TRANSPORTADORA
    if(!transportadora || transportadora.length < 3){
      const transportadoras = ['TRANSOLICAR', 'TRANSPORTE', 'LINEAS', 'CARGO', 'CARGA', 'ENVIOS', 'LOGISTICA', 'INTEGRAL', 'EXPRESS', 'FLEX', 'COORDINADORA', 'INTERLOGISTICA'];
      for(let t of transportadoras) {
        if(allTextUpper.includes(t)) {
          const regex = new RegExp(`\\b${t}[\\s\\w]*`, 'i');
          const match = allText.match(regex);
          if(match) {
            transportadora = match[0].trim().substring(0, 60);
            break;
          }
        }
      }
    }
    transportadora = transportadora.replace(/^https?.*$/i, '').trim().toUpperCase();
    
    // CONDUCTOR
    if(!conductor || conductor.length < 4){
      const nombreRegex = /\b([A-Z][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z][a-z√°√©√≠√≥√∫√±]+)+)\b/g;
      const matches = allText.match(nombreRegex);
      
      if(matches && matches.length > 0) {
        for(let m of matches) {
          if(m.length > 4 && m.length < 120 && 
             !m.match(/GOOGLE|DRIVE|DOCS|HTTP|SHEET|EDITOR|COPY|PRINT|EXPORT|SPREADSHEET|TIMESTAMP/i) &&
             !m.includes('@')) {
            conductor = m.trim();
            break;
          }
        }
      }
    }
    conductor = conductor.replace(/^https?.*$/i, '').trim().toUpperCase();
    
    // DESTINO
    if(!destino || destino.length < 3){
      const ciudades = ['BOGOTA', 'MEDELLIN', 'CALI', 'BARRANQUILLA', 'CARTAGENA', 'FINCA', 'BUGA', 'VILLA', 'ALMACEN', 'BODEGA', 'SANTA', 'POPAYAN', 'IBAGUE', 'MANIZALES', 'PEREIRA', 'ARMENIA', 'BUCARAMANGA', 'CUCUTA', 'VALLEDUPAR', 'MONTERIA', 'SINCELEJO', 'TUNJA', 'FLORENCIA', 'NEIVA', 'RIOHACHA', 'LETICIA', 'PASTO', 'VILLAVICENCIO', 'YOPAL', 'ARAUCA', 'INIRIDA', 'GUAINIA', 'HONDA', 'ESPINAL', 'TOLIMA', 'QUIBDO', 'PALMIRA', 'SOACHA'];
      for(let c of ciudades) {
        if(allTextUpper.includes(c)) {
          const regex = new RegExp(`\\b${c}\\b`, 'i');
          const match = allText.match(regex);
          if(match) {
            destino = match[0].toUpperCase();
            break;
          }
        }
      }
    }
    destino = destino.replace(/^https?.*$/i, '').trim().toUpperCase();
    
    // PRODUCTO
    if(!producto || producto.length < 3){
      const productos = ['METIONINA', 'GRANIZO', 'MAIZ', 'SORGO', 'CARNE', 'POLLO', 'HUESO', 'ALIMENTO', 'LIQUIDO', 'CONCENTRADO', 'HARINA', 'TRIGO', 'ARROZ', 'LECHE', 'QUESO', 'MARGARINA', 'ACEITE', 'AZUCAR', 'SAL', 'ESPECIAS', 'PIENSO', 'RACION', 'BALANCEADO', 'PREMIX', 'ADITIVO', 'VITAMIN', 'MINERAL', 'SUPLEMENTO', 'FORRAJE', 'SILAJE', 'PASTA', 'PELLET', 'NUTRIMENTO', 'RACI√ìN'];
      for(let p of productos) {
        if(allTextUpper.includes(p)) {
          const regex = new RegExp(`\\b${p}\\b`, 'i');
          const match = allText.match(regex);
          if(match) {
            producto = match[0].toUpperCase();
            break;
          }
        }
      }
    }
    producto = producto.replace(/^https?.*$/i, '').trim().toUpperCase();
    
    // FECHA
    if(!fecha || fecha.length < 8){
      const fechaRegex = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/;
      const match = allText.match(fechaRegex);
      if(match && match[1]) {
        fecha = match[1];
      }
    }
    fecha = fecha.replace(/^https?.*$/i, '').trim();
    
    // EVIDENCIA
    if(!evidencia || !evidencia.includes('http')) {
      const urlRegex = /(https?:\/\/[^\s]+)/;
      const match = allText.match(urlRegex);
      if(match && match[1]) {
        evidencia = match[1];
      }
    }

    let btnEvidencia = '';
    if(evidencia && (evidencia.includes('google.com') || evidencia.includes('drive.google.com') || evidencia.includes('http'))) {
      btnEvidencia = `<button class="btn-ver-evidencia" data-url="${evidencia}" style="background:#4CAF50;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">üëÅÔ∏è Ver</button>`;
    } else {
      btnEvidencia = '<span style="color:#999;font-size:12px;">Sin archivo</span>';
    }

    let btnEliminar = `<button class="btn-eliminar-registro" data-index="${originalIndex}" style="background:#d32f2f;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">üóëÔ∏è Eliminar</button>`;

    tr.innerHTML = `
      <td>${numeroFila}</td>
      <td>${transportadora || '‚Äî'}</td>
      <td>${conductor || '‚Äî'}</td>
      <td>${cedula || '‚Äî'}</td>
      <td>${placa || '‚Äî'}</td>
      <td>${destino || '‚Äî'}</td>
      <td>${producto || '‚Äî'}</td>
      <td>${fecha || '‚Äî'}</td>
      <td>${btnEvidencia}</td>
      <td>${btnEliminar}</td>
    `;

    tablaBody.appendChild(tr);
  });

  document.querySelectorAll('.btn-ver-evidencia').forEach(btn => {
    btn.addEventListener('click', function() {
      abrirEvidencia(this.getAttribute('data-url'));
    });
  });

  document.querySelectorAll('.btn-eliminar-registro').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const pass = prompt('üîê Ingresa la contrase√±a de administrador para eliminar:');
      
      if(pass === null) return;
      
      if(pass === ADMIN_PASS) {
        if(confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
          eliminarRegistro(index);
        }
      } else {
        alert('‚ùå Contrase√±a incorrecta');
      }
    });
  });

  filtradosEl.textContent = datos.length;
  registrosEl.textContent = datosOriginales.length;
}

      function aplicarFiltros(){
        const t = fTransport.value.trim().toLowerCase();
        const p = fPlaca.value.trim().toLowerCase();
        const c = fConductor.value.trim().toLowerCase();
        const f = fproducto.value.trim().toLowerCase();
        const fecha = fFecha.value;

        const filtrados = datosOriginales.filter(r=>{
          const transportadora = (r.transportadora || r['Transportadora'] || '').toLowerCase();
          const placa = (r.placa || r['Placa'] || '').toLowerCase();
          const conductor = (r.conductor || r['Conductor'] || '').toLowerCase();
          
          let producto = '';
          for(let key in r) {
            if(key.toLowerCase().includes('producto')) {
              producto = (r[key] || '').toLowerCase();
              break;
            }
          }
          
          let fechaRegistro = '';
          for(let key in r) {
            if(key.toLowerCase().includes('fecha')) {
              fechaRegistro = (r[key] || '');
              break;
            }
          }

          if(t && !transportadora.includes(t)) return false;
          if(p && !placa.includes(p)) return false;
          if(c && !conductor.includes(c)) return false;
          if(f && !producto.includes(f)) return false;
          
          if(fecha){
            const fechaObj = obtenerFechaISO(fechaRegistro);
            const [y, m, d] = fecha.split('-');
            const fechaFiltro = new Date(y, m - 1, d);
            if(!fechaObj) return false;
            if(
              fechaObj.getFullYear() !== fechaFiltro.getFullYear() ||
              fechaObj.getMonth() !== fechaFiltro.getMonth() ||
              fechaObj.getDate() !== fechaFiltro.getDate()
            ){
              return false;
            }
          }
          return true;
        });

        renderTabla(filtrados);
      }

      function descargarXLS(){ 
        if(!datosOriginales.length){ 
          alert('No hay datos para exportar'); 
          return; 
        } 
        
        const headers=['Transportadora','Conductor','C√©dula','Placa','Destino','Producto','Fecha','Evidencia']; 
        const rows=[headers.join('\t')]; 
        
        datosOriginales.forEach(r=>{ 
          let transportadora = (r.transportadora || r['Transportadora'] || '').trim().toUpperCase(); 
          let conductor = (r.conductor || r['Conductor'] || '').trim().toUpperCase(); 
          let cedula = (r.cedula || r['C√©dula'] || r['c√©dula'] || '').trim().toUpperCase(); 
          let placa = (r.placa || r['Placa'] || '').trim().toUpperCase(); 
          let destino = (r.destino || r['Destino'] || '').trim().toUpperCase(); 
          
          let producto = '';
          for(let key in r) {
            if(key.toLowerCase().includes('producto')) {
              producto = (r[key] || '').trim().toUpperCase();
              break;
            }
          }
          
          let fecha = '';
          for(let key in r) {
            if(key.toLowerCase().includes('fecha')) {
              fecha = (r[key] || '').trim().toUpperCase();
              break;
            }
          }
          
          let evidencia = '';
          for(let key in r) {
            if(key.toLowerCase().includes('evidencia')) {
              evidencia = (r[key] || '').trim();
              break;
            }
          }
          
          rows.push([transportadora,conductor,cedula,placa,destino,producto,fecha,evidencia].join('\t')); 
        }); 
        
        const blob=new Blob([rows.join('\n')],{type:'application/vnd.ms-excel'}); 
        const a=document.createElement('a'); 
        a.href=URL.createObjectURL(blob); 
        a.download=`despachos_${new Date().toISOString().slice(0,10)}.xls`; 
        a.click(); 
        URL.revokeObjectURL(a.href); 
      }

      function notificarNuevoRegistro(registro){
        const id = generarIDRegistro(registro);
        if(registrosNotificados.has(id)) return;
        registrosNotificados.add(id);
        
        let mensaje = `Nuevo registro despachado:\n`;
        mensaje += `üöõ Transportadora: ${registro.transportadora || '‚Äî'}\n`;
        mensaje += `üßëüèº‚Äç‚úàÔ∏è Conductor: ${registro.conductor || '‚Äî'}\n`;
        mensaje += `ü™™ C√©dula: ${registro.cedula || '‚Äî'}\n`;
        mensaje += `‚õî Placa: ${registro.placa || '‚Äî'}\n`;
        mensaje += `üìç Destino: ${registro.destino || '‚Äî'}\n`;
        mensaje += `üì¶ Producto: ${registro.producto || '‚Äî'}\n`;
        mensaje += `üìÖ Fecha: ${registro.fecha || '‚Äî'}\n`;
        mensaje += `üì∏ Evidencia: ${registro.evidencia || '‚Äî'}`;
        
        if(Notification.permission === 'granted'){
          new Notification('Nuevo registro despachado', {
            body: mensaje,
            icon: 'https://image.url/icon.png'
          });
        }else{
          console.log('Nuevo registro:', mensaje);
        }
      }

      function generarIDRegistro(registro){
        const cedula = (registro.cedula || registro['C√©dula'] || '').trim();
        const placa = (registro.placa || registro['Placa'] || '').trim();
        return `${cedula}|${placa}`;
      }

      function abrirEvidencia(url){
        if(!url || url.trim() === '#' || url.includes('javascript:void(0)')) return;
        window.open(url, '_blank');
      }

      function eliminarRegistro(index){
        if(index < 0 || index >= datosOriginales.length) return;
        datosOriginales.splice(index, 1);
        renderTabla(datosOriginales);
      }

      function solicitarPermisoNotificaciones(){
        if(Notification.permission === 'granted') return;
        if(Notification.permission !== 'denied'){
          Notification.requestPermission().then(permission => {
            if(permission === 'granted'){
              console.log('Permiso de notificaciones concedido');
            }else{
              console.log('Permiso de notificaciones denegado');
            }
          });
        }
      }

      const PROXY_TEMPLATES = [
        'https://api.allorigins.win/raw?url={url}',
        'https://thingproxy.freeboard.io/fetch/{url}',
        'https://api.codetabs.com/v1/proxy?quest={url}'
      ];

      function buildProxyUrls(){
        return PROXY_TEMPLATES.map(t => t.replace('{url}', encodeURIComponent(URL_CSV)) + '&t=' + Date.now());
      }

      const forceProxyEl = document.getElementById('forceProxy');
      try{ const pref = localStorage.getItem('useProxy'); if(pref==='1') forceProxyEl.checked = true; }catch(e){}
      forceProxyEl.addEventListener('change', ()=>{ try{ localStorage.setItem('useProxy', forceProxyEl.checked ? '1' : '0'); }catch(e){} });

      let lastCSVText = null;
      
      async function cargarDatos(){
        estadoEl.textContent = 'Actualizando‚Ä¶';
        errorMsg.style.display = 'none';

        const useProxy = forceProxyEl.checked;

        async function tryFetch(url){
          const t0 = performance.now();
          const res = await fetch(url, { cache: 'no-store' });
          const t1 = performance.now();
          const took = Math.round(t1 - t0);
          if(!res.ok) throw new Error('HTTP ' + res.status + ' (took ' + took + 'ms)');
          const text = await res.text();
          return { text, took };
        }

        const attempts = [];
        if(!useProxy){ attempts.push(URL_CSV + '&t=' + Date.now()); }
        attempts.push(...buildProxyUrls());

        let finalText = null; 
        let lastErr = null; 
        let tried = [];
        
        for(const url of attempts){
          tried.push(url);
          try{
            console.log('Intentando cargar: ' + url.substring(0, 80) + '...');
            const { text, took } = await tryFetch(url);
            finalText = text;
            console.log('‚úì Datos cargados exitosamente (' + took + 'ms)');
            break;
          }catch(e){ 
            lastErr = e; 
            console.warn('‚ùå Intento fallido:', e.message); 
          }
        }

        if(finalText === null){
          estadoEl.textContent = '‚ö† Error';
          errorMsg.innerHTML = 'Error: ' + (lastErr && lastErr.message ? lastErr.message : lastErr) + ' ‚Äî Comprueba que la hoja est√© publicada.' +
            '<br><small>Intentos: ' + tried.map(u=>u.split('?')[0]).join(', ') + '</small>';
          errorMsg.style.display = 'block';
          console.error('No se pudo cargar los datos despu√©s de ' + attempts.length + ' intentos');
          return;
        }

        if(lastCSVText === finalText){
          console.log('Los datos no han cambiado');
          ultimaEl.textContent = new Date().toLocaleTimeString();
          estadoEl.textContent = '‚úì OK';
          return;
        }

        console.log('Procesando datos...');
        
        // Cargar formulario de respuestas (sin bloquear si falla)
        datosFormulario = await cargarFormularioRespuestas();
        console.log('Datos del formulario disponibles: ' + datosFormulario.length);

        if(!lastCSVText){
          console.log('Primera carga - parseando CSV');
          datosOriginales = parseCSV(finalText);
          console.log('Registros parseados: ' + datosOriginales.length);
          
          // COMPLETAR REGISTROS CON DATOS DEL FORMULARIO
          if(datosFormulario.length > 0){
            console.log('Completando registros desde formulario...');
            datosOriginales = datosOriginales.map(r => {
              const registroCompleto = {...r};
              
              // Buscar por TRANSPORTADORA
              let formCoincidencia = null;
              const transportadora = (r.transportadora || r['Transportadora'] || '').trim().toUpperCase();
              
              if(transportadora && transportadora.length > 3){
                formCoincidencia = datosFormulario.find(f => {
                  const formTrans = (f.transportadora || f['Transportadora'] || '').trim().toUpperCase();
                  const formTransClean = formTrans.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  const transClean = transportadora.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  return formTransClean === transClean || formTransClean.includes(transClean);
                });
              }
              
              // Si encontr√≥, llenar todos los campos vac√≠os
              if(formCoincidencia){
                console.log('‚úì Completando: ' + transportadora);
                
                // Conductor
                const conductorActual = (r.conductor || r['Conductor'] || '').trim();
                if(!conductorActual || conductorActual.length < 3){
                  let formConductor = (formCoincidencia.conductor || formCoincidencia['Conductor'] || '').trim();
                  formConductor = formConductor.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  if(formConductor && formConductor.length > 3) {
                    registroCompleto.conductor = formConductor;
                    delete registroCompleto['Conductor'];
                  }
                }
                
                // C√©dula
                const cedulaActual = (r.cedula || r['C√©dula'] || r['c√©dula'] || '').trim();
                if(!cedulaActual || cedulaActual.length < 5){
                  let formCedula = (formCoincidencia.cedula || formCoincidencia['C√©dula'] || formCoincidencia['c√©dula'] || '').trim();
                  formCedula = formCedula.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  if(formCedula && formCedula.length >= 5) {
                    registroCompleto.cedula = formCedula;
                    delete registroCompleto['C√©dula'];
                    delete registroCompleto['c√©dula'];
                  }
                }
                
                // Placa
                const placaActual = (r.placa || r['Placa'] || '').trim();
                if(!placaActual || placaActual.length < 4){
                  let formPlaca = (formCoincidencia.placa || formCoincidencia['Placa'] || '').trim();
                  formPlaca = formPlaca.replace(/^"|"$/g, '').replace(/[""]/g, '').trim().toUpperCase();
                  if(formPlaca && formPlaca.length >= 4) {
                    registroCompleto.placa = formPlaca;
                    delete registroCompleto['Placa'];
                  }
                }
                
                // Destino
                const destinoActual = (r.destino || r['Destino'] || '').trim();
                if(!destinoActual || destinoActual.length < 3){
                  let formDestino = (formCoincidencia.destino || formCoincidencia['Destino'] || '').trim();
                  formDestino = formDestino.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  if(formDestino && formDestino.length >= 3) {
                    registroCompleto.destino = formDestino;
                    delete registroCompleto['Destino'];
                  }
                }
                
                // Producto
                const productoActual = (r.producto || r['Producto'] || r['producto a cargar'] || r['Producto a cargar'] || '').trim();
                if(!productoActual || productoActual.length < 3){
                  let formProducto = (formCoincidencia['producto a cargar'] || formCoincidencia['Producto a cargar'] || formCoincidencia.producto || formCoincidencia['Producto'] || '').trim();
                  formProducto = formProducto.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  if(formProducto && formProducto.length >= 3) {
                    registroCompleto.producto = formProducto;
                    delete registroCompleto['Producto'];
                    delete registroCompleto['Producto a cargar'];
                  }
                }
                
                // Fecha
                const fechaActual = (r.fecha || r['Fecha'] || r['fecha planificada de cargue'] || r['Fecha planificada de cargue'] || '').trim();
                if(!fechaActual || fechaActual.length < 8){
                  let formFecha = (formCoincidencia['fecha planificada de cargue'] || formCoincidencia['Fecha planificada de cargue'] || formCoincidencia.fecha || formCoincidencia['Fecha'] || '').trim();
                  formFecha = formFecha.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  if(formFecha && formFecha.length >= 8) {
                    registroCompleto.fecha = formFecha;
                    delete registroCompleto['Fecha'];
                    delete registroCompleto['Fecha planificada de cargue'];
                  }
                }
                
                // Evidencia
                const evidenciaActual = (r.evidencia || r['Evidencia'] || r['evidencia estado carrocer√≠a'] || r['Evidencia estado carrocer√≠a'] || '').trim();
                if(!evidenciaActual || !evidenciaActual.includes('http')){
                  let formEvidencia = (formCoincidencia['evidencia estado carrocer√≠a'] || formCoincidencia['Evidencia estado carrocer√≠a'] || formCoincidencia.evidencia || formCoincidencia['Evidencia'] || '').trim();
                  formEvidencia = formEvidencia.replace(/^"|"$/g, '').replace(/[""]/g, '').trim();
                  if(formEvidencia && formEvidencia.includes('http')) {
                    registroCompleto.evidencia = formEvidencia;
                    delete registroCompleto['Evidencia'];
                    delete registroCompleto['Evidencia estado carrocer√≠a'];
                  }
                }
              }
              
              return registroCompleto;
            });
            console.log('‚úì Todos los registros completados');
          }
          
          datosOriginales.forEach(r => {
            const id = generarIDRegistro(r);
            registrosNotificados.add(id);
          });
          
          console.log('Renderizando ' + datosOriginales.length + ' registros');
          renderTabla(datosOriginales);
        } else {
          console.log('Actualizaci√≥n incremental');
          const newLines = finalText.trim().split('\n');
          const oldLines = lastCSVText.trim().split('\n');
          
          if(newLines.length > oldLines.length){
            console.log('Nuevos registros detectados');
            const headers = newLines[0];
            const added = newLines.slice(oldLines.length).join('\n');
            const partialCSV = headers + '\n' + added;
            let nuevas = parseCSV(partialCSV);
            
            // COMPLETAR NUEVOS REGISTROS
            if(datosFormulario.length > 0){
              nuevas = nuevas.map(r => completarRegistroDesdeFormulario(r, datosFormulario));
            }
            
            nuevas.forEach(r => {
              const id = generarIDRegistro(r);
              if (!registrosNotificados.has(id)) {
                registrosNotificados.add(id);
                notificarNuevoRegistro(r);
              }
              datosOriginales.push(r);
            });
            renderTabla(datosOriginales);
          } else {
            console.log('Datos no cambiados, re-renderizando');
            datosOriginales = parseCSV(finalText);
            if(datosFormulario.length > 0){
              datosOriginales = datosOriginales.map(r => completarRegistroDesdeFormulario(r, datosFormulario));
            }
            renderTabla(datosOriginales);
          }
        }

        lastCSVText = finalText;
        ultimaEl.textContent = new Date().toLocaleTimeString();
        estadoEl.textContent = '‚úì OK';
        console.log('‚úì Carga completada');
      }

      btnFiltrar.addEventListener('click', aplicarFiltros);
      btnLimpiar.addEventListener('click', ()=>{
        fTransport.value='';
        fPlaca.value='';
        fConductor.value='';
        fproducto.value='';
        fFecha.value='';
        renderTabla(datosOriginales);
      });
      btnXLS.addEventListener('click', descargarXLS);
      btnActualizar.addEventListener('click', cargarDatos);

      solicitarPermisoNotificaciones();
      console.log('üöÄ Dashboard iniciado');
      cargarDatos();
      setInterval(cargarDatos, 5000);
    </script>
  </body>
</html>
