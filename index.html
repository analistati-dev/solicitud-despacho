<!DOCTYPE html>
<html lang="es">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title> üöõ Despacho</title>
    <style>
      html,body{height:100%;}
      *{box-sizing:border-box;margin:0;padding:0}
      body{ font-family: Arial, Helvetica, sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:0;display:flex;flex-direction:column}
      .container{width:100%;max-width:none;margin:0 auto;padding:20px;display:flex;flex-direction:column;min-height:100vh}
      header{background:linear-gradient(90deg,#05e479,#6610f2);color:#fff;padding:28px;border-radius:10px;margin-bottom:18px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.18)}
      .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:16px}
      .card{background:#fff;padding:16px;border-radius:10px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.08)}
      .card-label{font-size:11px;color:#666;text-transform:uppercase;margin-bottom:6px}
      .card-value{font-size:22px;font-weight:700;color:#000000}
      .controls{background:#fff;padding:14px;border-radius:10px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
      .controls .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:10px}
      input,select{padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
      .buttons{display:flex;gap:8px;flex-wrap:wrap}
      .btn{padding:10px 14px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
      .btn.primary{background:#0a66ff;color:#fff}
      .btn.success{background:#28a745;color:#fff}
      .btn.warn{background:#ffc107;color:#111}
      .error{display:none;background:#fdecea;color:#611;padding:10px;border-radius:6px;margin-bottom:10px}
      
      .table-wrap{
        background:#fff;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.06);
        margin-bottom:24px;flex:1;
        font-family: inherit;
        display:flex;
        flex-direction:column;
        overflow:auto;
      }

      .highlight{transition:background 0.6s ease; background:rgba(255,255,0,0.18)}
      .new-row{opacity:0.98}
      .table-header table{width:100%;border-collapse:collapse}
      .table-body{flex:1;overflow:auto}
      .table-body table{width:100%;border-collapse:collapse}
      thead th{background:linear-gradient(90deg,#0a66ff,#6610f2);color:#fff;padding:12px;text-align:left;font-size:13px;position:sticky;top:0}
      tbody td{padding:10px;border-bottom:1px solid #eee;font-size:13px}
      .status-cargando{background:#ffc107;color:#000;padding:4px 10px;border-radius:999px;font-weight:700}
      .status-despachado{background:#28a745;color:#fff;padding:4px 10px;border-radius:999px;font-weight:700}
      .empty{padding:26px;text-align:center;color:#777}
      @media(max-width:768px){.controls .row{grid-template-columns:1fr}.buttons{flex-direction:column}.btn{width:100%}}
    table{ border-collapse:collapse; } thead th{ border:3px solid rgb(0, 0, 0); } tbody td{ border:3px solid #0b0a0a; }
    /* ===== FIX TABLA EN CELULAR ===== */
@media (max-width: 600px){

  body,
  .container{
    height: auto !important;
    min-height: auto !important;
  }

  .table-wrap{
    flex: none !important;
    max-height: none !important;
    overflow-x: auto;
    overflow-y: visible;
    margin-bottom: 40px;
  }

  table{
    min-width: 900px;
  }
}
thead th:first-child,
tbody td:first-child{
  text-align: center;
  font-weight: bold;
}

    </style>
  </head>
  <body>
    <div class="container">
      <header>
       <h1 style="font-size:60px;">
       üì¶ SOLICITUD DE DESPACHO
      </h1>
          
      </header>

      <div class="dashboard">
        <div class="card"><div class="card-label">üìù Total Registros</div><div id="registros" class="card-value">0</div></div>
        <div class="card"><div class="card-label">üìà Filtrados</div><div id="filtrados" class="card-value">0</div></div>
        <div class="card"><div class="card-label">‚úÖ Estado</div><div id="estado" class="card-value">‚óè</div></div>
        <div class="card"><div class="card-label">üåê √öltima actualizaci√≥n</div><div id="ultima" class="card-value">‚Äî</div></div>
      </div>

      <div class="controls">
        <div id="errorMsg" class="error"></div>
        <div class="row">
          <input id="filterTransportadora" placeholder="Transportadora">
          <input id="filterPlaca" placeholder="Placa">
          <input id="filterConductor" placeholder="Conductor">
          <input id="filterproducto" placeholder="Producto">
          <input id="filterFecha" type="date">
          
        </div>
        <div class="buttons">
          <button id="btnFiltrar" class="btn primary">üîç Aplicar filtros</button>
          <button id="btnLimpiar" class="btn warn">üîÑ Limpiar</button>
          <button id="btnDescargarExcel" class="btn success">üìä Descargar Excel</button>
          <button id="btnActualizar" class="btn primary">üîÅ Sincronizar ahora</button>
         
          <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px;color:#222">
            <input type="checkbox" id="forceProxy"> 
          </label>
        </div>
      </div>

      <div id="dashboardPanel" style="display:none;background:#ffffffb4;padding:16px;border-radius:10px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)">


  <div class="row" style="margin-bottom:12px">
    <select id="dTransportadora"><option value="">Transportadora</option></select>
    <select id="dConductor"><option value="">Conductor</option></select>
    <select id="dProducto"><option value="">Producto</option></select>
    <input type="date" id="dFecha">
  </div>

  <canvas id="chartTransportadora" height="120"></canvas>
  <canvas id="chartConductor" height="120" style="margin-top:20px"></canvas>
  <canvas id="chartProducto" height="120" style="margin-top:20px"></canvas>
</div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>üöõ Transportadora </th>
              <th>üßëüèº‚Äç‚úàÔ∏è Conductor</th>
              <th>ü™™ C√©dula</th>
              <th>‚õî Placa</th>
              <th>üìç Destino</th>
              <th>üì¶ Producto</th>
              <th>üìÖ Fecha Planificada de Cargue</th>
              <th>üì∏ Evidencia Estado Carrocer√≠a</th>
              <th>üóëÔ∏è Eliminar</th></tr>
          </thead>
          <tbody id="tablaBody"><tr><td colspan="10" class="empty">Cargando datos...</td></tr></tbody>
        </table>
      </div>

      <!-- Modal para ver evidencia - DESHABILITADO, se abre en nueva pesta√±a -->
      <!-- C√≥digo anterior removido: se usa window.open() en su lugar -->
    </div>
     
    <script>
      const URL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTuMV8Hfu6NBC0w2vuWseAmTcU957vz_ZfYwluoop1BaDvs80SiuJFJYA2H8UFv0zAw8hbB5CqygIIO/pub?gid=651791819&single=true&output=csv';
      let datosOriginales = [];
      let registrosNotificados = new Set();


      const tablaBody = document.getElementById('tablaBody');
      const registrosEl = document.getElementById('registros');
      const filtradosEl = document.getElementById('filtrados');
      const ultimaEl = document.getElementById('ultima');
      const estadoEl = document.getElementById('estado');
      const errorMsg = document.getElementById('errorMsg');

      const fTransport = document.getElementById('filterTransportadora');
      const fPlaca = document.getElementById('filterPlaca');
      const fConductor = document.getElementById('filterConductor');
      const fproducto = document.getElementById('filterproducto');
      const fFecha=document.getElementById('filterFecha');
      

      const btnFiltrar = document.getElementById('btnFiltrar');
      const btnLimpiar = document.getElementById('btnLimpiar');
    
      const btnXLS = document.getElementById('btnDescargarExcel');
      const btnActualizar = document.getElementById('btnActualizar');

      function parseCSV(text){
        const rows=[];
        
        // Primero, necesitamos identificar d√≥nde termina el header
        // El header puede estar en m√∫ltiples l√≠neas si tiene comillas desequilibradas
        let headerEndLine = 0;
        let quoteCount = 0;
        const lines = text.replace(/\r/g,'').split('\n');
        
        // Encontrar la l√≠nea donde el header termina (cuando las comillas se cierren)
        for(let i = 0; i < lines.length; i++) {
          const line = lines[i];
          for(let j = 0; j < line.length; j++) {
            if(line[j] === '"') quoteCount++;
          }
          // Si el n√∫mero de comillas es par, el header termin√≥
          if(quoteCount % 2 === 0 && quoteCount > 0) {
            headerEndLine = i;
            break;
          }
        }
        
        // Reconstruir el header juntando todas las l√≠neas del encabezado
        let headerLine = '';
        for(let i = 0; i <= headerEndLine; i++) {
          headerLine += lines[i] + ' ';
        }
        headerLine = headerLine.trim();
        
        console.log('Header completo:', headerLine);
        
        // Parser m√°s robusto para CSV con comillas
        function parseCSVLine(line) {
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for(let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];
            
            if(char === '"') {
              if(inQuotes && nextChar === '"') {
                current += '"';
                i++;
              } else {
                inQuotes = !inQuotes;
              }
            } else if(char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        }
        
        // Procesar headers
        const headers=[]; 
        const headerValues = parseCSVLine(headerLine);
        headerValues.forEach(h => {
          let clean = h.toLowerCase();
          // Limpiar caracteres escapados y comillas mal formateadas
          clean = clean.replace(/^\\"|"$/g, '').replace(/\\"/g, '"').replace(/^\"|\"$/g, '').trim();
          // Eliminar caracteres especiales como emojis y caracteres de control, pero mantener espacios
          clean = clean.replace(/[^\w\s\√°√©√≠√≥√∫√±\-]/g, '').trim();
          headers.push(clean);
        });
        
        console.log('Headers procesados:', headers);
        console.log('Total headers:', headers.length);
        
        // Procesar datos (empezar despu√©s del header)
        for(let i = headerEndLine + 1; i < lines.length; i++){
          const line = lines[i].trim();
          if(!line) continue;
          
          const values = parseCSVLine(line);
          const obj={}; 
          for(let j=0;j<headers.length;j++) {
            obj[headers[j]] = values[j] || '';
          }
          
          // Validaci√≥n: si la primera columna est√° vac√≠a, probablemente es una fila incompleta
          if(headers[0] && obj[headers[0]]) {
            rows.push(obj);
          }
        } 
        return rows;
      }
      function obtenerFechaISO(valor){
  if(!valor) return null;

  // quitar hora
  valor = valor.trim().split(' ')[0];

  // DD/MM/YYYY
  if(valor.includes('/')){
    const [d,m,y] = valor.split('/');
    return new Date(y, m-1, d);
  }

  // YYYY-MM-DD
  if(valor.match(/^\d{4}-\d{2}-\d{2}$/)){
    const [y,m,d] = valor.split('-');
    return new Date(y, m-1, d);
  }

  return null;
}


function renderTabla(datos){
  tablaBody.innerHTML = '';

  if(!datos.length){
    tablaBody.innerHTML =
      '<tr><td colspan="10" class="empty">No hay datos</td></tr>';
    filtradosEl.textContent = '0';
    return;
  }

  // Invertir orden (m√°s reciente primero) - SIEMPRE
  const datosInvertidos = Array.from(datos).reverse();
  console.log('Total registros:', datos.length, 'Primer registro despu√©s de invertir:', datosInvertidos[0]);

  datosInvertidos.forEach((r, displayIndex) => {
    const tr = document.createElement('tr');
    const originalIndex = datos.length - 1 - displayIndex;
    const numeroFila = datos.length - displayIndex; // N√∫mero invertido
    tr.setAttribute('data-index', originalIndex);
    
    // Normalizar campos - buscar en m√∫ltiples variantes y limpiar datos
    let transportadora = (r.transportadora || r['Transportadora'] || r['transportadora'] || '').trim();
    let conductor = (r.conductor || r['Conductor'] || r['conductor'] || '').trim();
    let cedula = (r.cedula || r['C√©dula'] || r['c√©dula'] || r['cedula'] || '').trim();
    let placa = (r.placa || r['Placa'] || r['placa'] || '').trim();
    let destino = (r.destino || r['Destino'] || r['destino'] || '').trim();
    
    // Buscar producto - puede estar bajo varios nombres
    let producto = '';
    for(let key in r) {
      if(key.includes('producto')) {
        producto = r[key].trim();
        break;
      }
    }
    
    // Buscar fecha
    let fecha = '';
    for(let key in r) {
      if(key.includes('fecha')) {
        fecha = r[key].trim();
        break;
      }
    }
    
    // Buscar evidencia
    let evidencia = '';
    for(let key in r) {
      if(key.includes('evidencia')) {
        evidencia = r[key].trim();
        break;
      }
    }
    
    // VALIDACI√ìN: Si la c√©dula est√° vac√≠a pero el conductor o transportadora contiene d√≠gitos (patr√≥n de c√©dula)
    // y no tiene caracteres de nombre, es probable que est√© desplazada
    if(!cedula) {
      // Buscar en transportadora si parece c√©dula (n√∫meros, guiones, etc)
      if(transportadora && /^\d{4,}/.test(transportadora.replace(/[-\s]/g, ''))) {
        const partes = transportadora.split(/\s+/);
        const potencialCedula = partes[0];
        if(/^\d{4,}[a-zA-Z]?$/.test(potencialCedula.replace(/[-\s]/g, ''))) {
          cedula = potencialCedula;
          transportadora = partes.slice(1).join(' ');
        }
      }
      // Buscar en conductor si parece c√©dula
      if(!cedula && conductor && /^\d{4,}/.test(conductor.replace(/[-\s]/g, ''))) {
        const partes = conductor.split(/\s+/);
        const potencialCedula = partes[0];
        if(/^\d{4,}[a-zA-Z]?$/.test(potencialCedula.replace(/[-\s]/g, ''))) {
          cedula = potencialCedula;
          conductor = partes.slice(1).join(' ');
        }
      }
    }
    
    // Convertir a may√∫sculas
    transportadora = transportadora.toUpperCase();
    conductor = conductor.toUpperCase();
    cedula = cedula.toUpperCase();
    placa = placa.toUpperCase();
    destino = destino.toUpperCase();
    producto = producto.toUpperCase();
    fecha = fecha.toUpperCase();

    // Crear bot√≥n para evidencia
    let btnEvidencia = '';
    if(evidencia && (evidencia.includes('google.com') || evidencia.includes('drive.google.com') || evidencia.includes('http'))) {
      btnEvidencia = `<button class="btn-ver-evidencia" data-url="${evidencia}" style="background:#4CAF50;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">üëÅÔ∏è Ver</button>`;
    } else {
      btnEvidencia = '<span style="color:#999;font-size:12px;">Sin archivo</span>';
    }

    // Bot√≥n para eliminar
    let btnEliminar = `<button class="btn-eliminar-registro" data-index="${originalIndex}" style="background:#d32f2f;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">üóëÔ∏è Eliminar</button>`;

    tr.innerHTML = `
      <td>${numeroFila}</td>
      <td>${transportadora}</td>
      <td>${conductor}</td>
      <td>${cedula}</td>
      <td>${placa}</td>
      <td>${destino}</td>
      <td>${producto}</td>
      <td>${fecha}</td>
      <td>${btnEvidencia}</td>
      <td>${btnEliminar}</td>
    `;

    tablaBody.appendChild(tr);
  });

  // Agregar listeners a botones de evidencia
  document.querySelectorAll('.btn-ver-evidencia').forEach(btn => {
    btn.addEventListener('click', function() {
      abrirEvidencia(this.getAttribute('data-url'));
    });
  });

  // Agregar listeners a botones de eliminar
  document.querySelectorAll('.btn-eliminar-registro').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      if(confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
        eliminarRegistro(index);
      }
    });
  });

  filtradosEl.textContent = datos.length;
  registrosEl.textContent = datosOriginales.length;
}

      function aplicarFiltros(){
  const t = fTransport.value.trim().toLowerCase();
  const p = fPlaca.value.trim().toLowerCase();
  const c = fConductor.value.trim().toLowerCase();
  const f = fproducto.value.trim().toLowerCase();
  const fecha = fFecha.value;

  const filtrados = datosOriginales.filter(r=>{
    // Normalizar valores y comparar
    const transportadora = (r.transportadora || r['Transportadora'] || '').toLowerCase();
    const placa = (r.placa || r['Placa'] || '').toLowerCase();
    const conductor = (r.conductor || r['Conductor'] || '').toLowerCase();
    
    // Buscar producto
    let producto = '';
    for(let key in r) {
      if(key.includes('producto')) {
        producto = r[key].toLowerCase();
        break;
      }
    }
    
    // Buscar fecha en todas las variantes
    let fechaRegistro = '';
    for(let key in r) {
      if(key.includes('fecha')) {
        fechaRegistro = r[key];
        break;
      }
    }

    if(t && !transportadora.includes(t)) return false;
    if(p && !placa.includes(p)) return false;
    if(c && !conductor.includes(c)) return false;
    if(f && !producto.includes(f)) return false;
    
    if(fecha){
      const fechaObj = obtenerFechaISO(fechaRegistro);
      const [y, m, d] = fecha.split('-');
      const fechaFiltro = new Date(y, m - 1, d);

      if(!fechaObj) return false;

      if(
        fechaObj.getFullYear() !== fechaFiltro.getFullYear() ||
        fechaObj.getMonth() !== fechaFiltro.getMonth() ||
        fechaObj.getDate() !== fechaFiltro.getDate()
      ){
        return false;
      }
    }

    return true;
  });

  renderTabla(filtrados);
}

    

      function descargarXLS(){ if(!datosOriginales.length){ alert('No hay datos para exportar'); return; } const headers=['Transportadora','Conductor','C√©dula','Placa','Destino','Producto','Fecha','Evidencia',]; const rows=[headers.join('\t')]; datosOriginales.forEach(r=>{ let transportadora = (r.transportadora || r['Transportadora'] || '').toUpperCase(); let conductor = (r.conductor || r['Conductor'] || '').toUpperCase(); let cedula = (r.cedula || r['C√©dula'] || r['c√©dula'] || '').toUpperCase(); let placa = (r.placa || r['Placa'] || '').toUpperCase(); let destino = (r.destino || r['Destino'] || '').toUpperCase(); let producto = (r.producto || r['Producto'] || r['\"producto'] || '').toUpperCase(); let fecha = (r['\"Fecha planificada'] || r['\"fecha planificada'] || r['Fecha planificada'] || r['fecha planificada de cargue'] || r.fecha || r['Fecha Planificada de Cargue'] || r['Fecha'] || r[''] || '').toUpperCase(); let evidencia = r['evidencia estado carrocer√≠a'] || r['Evidencia estado carrocer√≠a'] || r['evidencia'] || ''; if(transportadora.includes('FECHA PLANIFICADA') && !fecha) { fecha = transportadora; transportadora = ''; } rows.push([transportadora,conductor,cedula,placa,destino,producto,fecha,evidencia].join('\t')); }); const blob=new Blob([rows.join('\n')],{type:'application/vnd.ms-excel'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`despachos_${new Date().toISOString().slice(0,10)}.xls`; a.click(); URL.revokeObjectURL(a.href); }

      const PROXY_TEMPLATES = [
        'https://api.allorigins.win/raw?url={url}',
        'https://thingproxy.freeboard.io/fetch/{url}',
        'https://api.codetabs.com/v1/proxy?quest={url}'
      ];
      let lastCSVText = '';
      const forceProxyEl = document.getElementById('forceProxy');

      // Restore user preference
      try{ const pref = localStorage.getItem('useProxy'); if(pref==='1') forceProxyEl.checked = true; }catch(e){}

      forceProxyEl.addEventListener('change', ()=>{ try{ localStorage.setItem('useProxy', forceProxyEl.checked ? '1' : '0'); }catch(e){} });

      function buildProxyUrls(){
        return PROXY_TEMPLATES.map(t => t.replace('{url}', encodeURIComponent(URL_CSV)) + '&t=' + Date.now());
      }

 function appendRows(rows){
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    
    // Normalizar campos
    let transportadora = (r.transportadora || r['Transportadora'] || '').trim();
    let conductor = (r.conductor || r['Conductor'] || '').trim();
    let cedula = (r.cedula || r['C√©dula'] || r['c√©dula'] || '').trim();
    let placa = (r.placa || r['Placa'] || '').trim();
    let destino = (r.destino || r['Destino'] || '').trim();
    
    // Buscar producto
    let producto = '';
    for(let key in r) {
      if(key.includes('producto')) {
        producto = r[key].trim();
        break;
      }
    }
    
    // Buscar fecha
    let fecha = '';
    for(let key in r) {
      if(key.includes('fecha')) {
        fecha = r[key].trim();
        break;
      }
    }
    
    // Buscar evidencia
    let evidencia = '';
    for(let key in r) {
      if(key.includes('evidencia')) {
        evidencia = r[key].trim();
        break;
      }
    }
    
    // VALIDACI√ìN: Si la c√©dula est√° vac√≠a pero el conductor o transportadora contiene d√≠gitos
    if(!cedula) {
      if(transportadora && /^\d{4,}/.test(transportadora.replace(/[-\s]/g, ''))) {
        const partes = transportadora.split(/\s+/);
        const potencialCedula = partes[0];
        if(/^\d{4,}[a-zA-Z]?$/.test(potencialCedula.replace(/[-\s]/g, ''))) {
          cedula = potencialCedula;
          transportadora = partes.slice(1).join(' ');
        }
      }
      if(!cedula && conductor && /^\d{4,}/.test(conductor.replace(/[-\s]/g, ''))) {
        const partes = conductor.split(/\s+/);
        const potencialCedula = partes[0];
        if(/^\d{4,}[a-zA-Z]?$/.test(potencialCedula.replace(/[-\s]/g, ''))) {
          cedula = potencialCedula;
          conductor = partes.slice(1).join(' ');
        }
      }
    }
    
    // Convertir a may√∫sculas
    transportadora = transportadora.toUpperCase();
    conductor = conductor.toUpperCase();
    cedula = cedula.toUpperCase();
    placa = placa.toUpperCase();
    destino = destino.toUpperCase();
    producto = producto.toUpperCase();
    fecha = fecha.toUpperCase();

    // Crear bot√≥n para evidencia
    let btnEvidencia = '';
    if(evidencia && (evidencia.includes('google.com') || evidencia.includes('drive.google.com') || evidencia.includes('http'))) {
      btnEvidencia = `<button class="btn-ver-evidencia" data-url="${evidencia}" style="background:#4CAF50;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">üëÅÔ∏è Ver</button>`;
    } else {
      btnEvidencia = '<span style="color:#999;font-size:12px;">Sin archivo</span>';
    }

    // Bot√≥n para eliminar
    let btnEliminar = `<button class="btn-eliminar-registro" data-index="${datosOriginales.length - 1}" style="background:#d32f2f;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold;">üóëÔ∏è Eliminar</button>`;

    tr.innerHTML = `
      <td>${datosOriginales.length}</td>
      <td>${transportadora}</td>
      <td>${conductor}</td>
      <td>${cedula}</td>
      <td>${placa}</td>
      <td>${destino}</td>
      <td>${producto}</td>
      <td>${fecha}</td>
      <td>${btnEvidencia}</td>
      <td>${btnEliminar}</td>
    `;

    tr.classList.add('new-row');
    tablaBody.appendChild(tr);

    setTimeout(() => tr.classList.add('highlight'), 50);
    setTimeout(() => tr.classList.remove('highlight'), 3500);
  });

  // Agregar listeners a botones de evidencia
  document.querySelectorAll('.btn-ver-evidencia').forEach(btn => {
    btn.addEventListener('click', function() {
      abrirEvidencia(this.getAttribute('data-url'));
    });
  });

  // Agregar listeners a botones de eliminar
  document.querySelectorAll('.btn-eliminar-registro').forEach(btn => {
    btn.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      if(confirm('¬øEst√°s seguro de que deseas eliminar este registro?')) {
        eliminarRegistro(index);
      }
    });
  });

  registrosEl.textContent = datosOriginales.length;
  filtradosEl.textContent = datosOriginales.length;
}

function generarIDRegistro(r){
  return `${r.fecha}|${r.placa}|${r.transportadora}`.toLowerCase();
}

function solicitarPermisoNotificaciones(){
  if (!("Notification" in window)) return;

  if (Notification.permission === "default") {
    Notification.requestPermission();
  }
}

function notificarNuevoRegistro(registro){
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;

  new Notification("üì¶ Nuevo despacho registrado", {
    body:
      `üöõ ${registro.transportadora || ''}\n` +
      `‚õî Placa: ${registro.placa || ''}\n` +
      `üì¶ Producto: ${registro.producto || ''}`,
    icon: "https://cdn-icons-png.flaticon.com/512/1995/1995574.png"
  });
}

      async function cargarDatos(){
        estadoEl.textContent = 'Actualizando‚Ä¶';
        errorMsg.style.display = 'none';

        const useProxy = forceProxyEl.checked;

        async function tryFetch(url){
          const t0 = performance.now();
          const res = await fetch(url, { cache: 'no-store' });
          const t1 = performance.now();
          const took = Math.round(t1 - t0);
          if(!res.ok) throw new Error('HTTP ' + res.status + ' (took ' + took + 'ms)');
          const text = await res.text();
          return { text, took };
        }

        // Build attempt list (direct + multiple proxies)
        const attempts = [];
        if(!useProxy){ attempts.push(URL_CSV + '&t=' + Date.now()); }
        attempts.push(...buildProxyUrls());

        let finalText = null; let lastErr = null; let tookMs = null; let tried = [];
        for(const url of attempts){
          tried.push(url);
          try{
            const { text, took } = await tryFetch(url);
            finalText = text;
            tookMs = took;
            break;
          }catch(e){ lastErr = e; console.warn('fetch attempt failed', e); }
        }

        if(finalText === null){
          estadoEl.textContent = '‚ö† Error';
          errorMsg.innerHTML = 'Error: ' + (lastErr && lastErr.message ? lastErr.message : lastErr) + ' ‚Äî Comprueba que la hoja est√© publicada.' +
            '<br><small>Intentos: ' + tried.map(u=>u.split('?')[0]).join(', ') + '</small>';
          errorMsg.style.display = 'block';
          return;
        }

        // If data unchanged, just update timestamp and status
        if(lastCSVText === finalText){
          ultimaEl.textContent = new Date().toLocaleTimeString();
          estadoEl.textContent = '‚úì OK';
          return;
        }

        // New or first-time data
        if(!lastCSVText){
          // full parse and render
          datosOriginales = parseCSV(finalText);
          console.log('Campos recibidos:', Object.keys(datosOriginales[0] || {}));
          console.log('Total campos:', Object.keys(datosOriginales[0] || {}).length);
          console.log('Total registros:', datosOriginales.length);
          
          // Buscar y mostrar registro 218
          if(datosOriginales.length >= 218) {
            console.log('\n=== REGISTRO 218 COMPLETO ===');
            const reg218 = datosOriginales[217]; // √≠ndice 217 = registro 218
            console.log('Todas las claves y valores:');
            for(let key in reg218) {
              console.log(`  "${key}": "${reg218[key]}"`);
            }
          }
          
          console.log('\n=== BUSCANDO CAMPO DE EVIDENCIA EN TODOS LOS REGISTROS ===');
          for(let i = 0; i < Math.min(10, datosOriginales.length); i++) {
            const r = datosOriginales[i];
            console.log(`\nRegistro ${i}:`);
            for(let key in r) {
              console.log(`  "${key}": "${r[key]}"`);
            }
          }
           datosOriginales.forEach(r => {
    const id = generarIDRegistro(r);
    registrosNotificados.add(id); // marcar como ya vistos
  });
          renderTabla(datosOriginales);
        } else {
          // incremental: compute new lines and append
          const newLines = finalText.trim().split('\n');
          const oldLines = lastCSVText.trim().split('\n');
          if(newLines.length > oldLines.length){
            const headers = newLines[0];
            const added = newLines.slice(oldLines.length).join('\n');
            const partialCSV = headers + '\n' + added;
            const nuevas = parseCSV(partialCSV);
            // append to datosOriginales and table
nuevas.forEach(r => {
  const id = generarIDRegistro(r);

  if (!registrosNotificados.has(id)) {
    registrosNotificados.add(id);
    notificarNuevoRegistro(r); // üîî solo una vez
  }

  datosOriginales.push(r);
});

appendRows(nuevas);


          } else {
            // different but same number of lines (edited rows) ‚Äî re-render full
            datosOriginales = parseCSV(finalText);
            renderTabla(datosOriginales);
          }
        }

        lastCSVText = finalText;
        ultimaEl.textContent = new Date().toLocaleTimeString();
        estadoEl.textContent = '‚úì OK';
      }

      btnFiltrar.addEventListener('click',aplicarFiltros);
btnLimpiar.addEventListener('click',()=>{
  fTransport.value='';
  fPlaca.value='';
  fConductor.value='';
  fproducto.value='';
  fFecha.value='';
  renderTabla(datosOriginales);
});
     
      btnXLS.addEventListener('click',descargarXLS);
      btnActualizar.addEventListener('click',cargarDatos);

      // Funci√≥n para eliminar registros
      function eliminarRegistro(index) {
        if(index >= 0 && index < datosOriginales.length) {
          datosOriginales.splice(index, 1);
          renderTabla(datosOriginales);
        }
      }

      // Funci√≥n para abrir evidencia en nueva pesta√±a
      function abrirEvidencia(url) {
        if(!url || !url.trim()) {
          alert('No hay archivo disponible');
          return;
        }

        url = url.trim();

        // Detectar tipo de archivo
        const esGoogleDrive = url.includes('drive.google.com') || url.includes('docs.google.com/open');

        // Si es Google Drive, extraer ID y generar URL de preview
        let urlFinal = url;
        if(esGoogleDrive && url.includes('id=')) {
          const id = url.split('id=')[1].split('&')[0];
          urlFinal = `https://drive.google.com/file/d/${id}/preview`;
        }

        // Abrir en nueva pesta√±a
        window.open(urlFinal, '_blank', 'noopener,noreferrer');
      }

      solicitarPermisoNotificaciones();
      cargarDatos();
      setInterval(cargarDatos, 5000);

    </script>
  </body>
</html>

  

 
   
       
         
